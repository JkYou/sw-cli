#!/usr/bin/env node
const path=require('path')
const userHome=require('user-home')
const exists = require('fs').existsSync
const inquirer=require('inquirer')
const download=require('download-git-repo')
const chalk=require('chalk')

const ora=require('ora')
const rm = require('rimraf').sync
const fetchTemplateList=require('../utils/fetch-template-list')
const generate=require('../utils/generate-project')

Main()

/**
 * Main
 */
function Main(){
  //æœ¬åœ°æ¨¡æ¿å­˜æ”¾ä»“åº“
  
  const tmpRepo=path.resolve(userHome,'.templates')
  //èŽ·å–æ¨¡æ¿åˆ—è¡¨
  fetchTemplateList((templateList)=>{
    const choices=templateList.map(template=>{
      return {
        name:`${template.name} - ${template.description}`,
        value:template.name
      }
    })
    inquirer.prompt([{
      type:'list',
      name:'template',
      choices,
      message:'é€‰æ‹©ä½ éœ€è¦çš„æ¨¡æ¿'
    }]).then(answer=>{
      //æ¨¡æ¿åç§°
      const tmpName=answer.template
      //è¿œç¨‹æ¨¡æ¿åœ°å€
      const tmpUrl=templateList.find(template=>template.name===tmpName).url
      const tmpDest=path.join(tmpRepo,tmpName)
      if(exists(tmpDest)){
        inquirer.prompt([
          {
            type:'confirm',
            name:'override',
            message:'æœ¬åœ°å·²ç»å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–?'
          }
        ]).then(answer=>{
          if(answer.override) {
            rm(tmpDest)
            
            downloadAndGenerate(tmpRepo,tmpName,tmpUrl)
          }else{
            generate(tmpDest)
          }
        });
      }else{
        downloadAndGenerate(tmpRepo,tmpName,tmpUrl)
      }  
    })
  })
}
/**
 * 
 * @param {String} tmpRepo 
 * @param {String} tmpName 
 * @param {String} tmpUrl 
 */
function downloadAndGenerate(tmpRepo,tmpName,tmpUrl){
  const spinner=ora('âœ¨ downloading template...')
  const tmpDest=path.join(tmpRepo,tmpName)
  inquirer.prompt([{
    type:'input',
    name:'branch',
    message:`è¯·è¾“å…¥ ${tmpName} é¡¹ç›®çš„åˆ†æ”¯ï¼Ÿ`,
    default:'master'
  }]).then(answer=>{
    spinner.start()
    download(`${tmpUrl}#${answer.branch}`,tmpDest,{
      clone:false
    },(err)=>{
      if(err){
        spinner.fail(chalk.red('âš™  download template unsuccessfully'))
        console.log(err)
      }else{
        spinner.succeed(chalk.green('ðŸš€ download template successfully'))
        generate(tmpDest)
      }
    })
  })
}


